<!DOCTYPE html>
<html lang="zh">

  <head>
    <title>光明顶</title>
     <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/webfont/1.3.0/webfont.js"></script>
      <link rel="stylesheet" type="text/css" href="http://blog.hhyue.com/theme/css/icons.css"/>
      <link rel="stylesheet" type="text/css" href="http://blog.hhyue.com/theme/css/styles.css"/>
      <meta charset="utf-8" />
  </head>

  <body id="index">
    <!-- header -->
    <header class="siteheader">
      <!-- site image -->

      <div class = "sitebanner">
        <h1><a class="sitetitle nodec" href="http://blog.hhyue.com">光明顶</a></h1>
        <h3 class ="sitesubtitle"></h3>
        <!-- nav -->
        <nav class="menu">
          <ul>
            <!-- menu items-->
            <!--pages-->
            <!-- services icons -->
              <li><a class="nodec icon-github" href="https://github.com/YueHonghui"></a></li>
              <li><a class="nodec icon-bitbucket" href="https://bitbucket.org/YueHonghui"></a></li>
          </ul>
        </nav>
      </div> <!-- sitebanner -->
    </header>

    <!-- content -->

<section class="content">

  <h3 class="posttitle">
    <a class="nodec" href="/when_to_use_assert.html" rel="bookmark" title="Permalink to 什么时候该用assert">
      什么时候该用assert
    </a>
  </h3>

  <div class="postinfo">
    <p class="published" title="2013-11-01T15:09:00">
      2013-11-01 15:09:00
    </p>

  </div><!-- .postinfo -->

  <div class="article">
    <p>什么时候适合用assert? 今天跟同事争论起这个话题, 特别想就这个问题展开讨论讨论. </p>
<p><strong>适合用assert的地方</strong> :</p>
<ol>
<li>侦测到程序逻辑有bug, 即程序状态超出了既定符合逻辑的状态集, 这种错误一定是由程序员引入的</li>
<li>内部代码中, 进入某个语句块时, 违反了该语句块约定的前提, 这种错误也一定是程序员引入或者由第一个错误引入</li>
</ol>
<p>对于第1种情况, 比如野指针, 内存状态明显违反代码逻辑, 这种情况下, 应该立即中止程序的运行, 保留现场, 这样可以尽快地从现场提供的信息中修复bug. 可能一个反对的理由是, 在发生第1种情况时, 应该优雅地退出, 比如清理IO, 这样可以尽可能少地丢失数据或者减少数据不一致性. 实际上, 这种想法是一厢情愿, 可能会让数据的破坏越来越严重. 如何能保证在一个错误的内存状态上, 在一个失控的程序逻辑上, 所作的挽回损失的步骤就一定如你所预期? 这种情况下, 再作任何努力都是徒劳的, 都是"在错误的道路上越走越远".</p>
<p>第2种情况, 比如一个函数的行为是将结果写入到参数传输进来的一个指针上, 如下代码:</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="n">func</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">ibuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">in_len</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">obuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">max_len</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">*</span> <span class="n">out_len</span><span class="p">)</span>
</pre></div>


<p>如果检测发现ibuf=NULL, 参数非法, 这一定是调用这个函数的程序员的造成的问题(除非这个函数明确说明被设计成对错误作一些容忍, 即使在这种情况下, 也有不能容忍的情况, 比如ibuf=NULL, 且in_len!=0), 这种情况, 倾向于用assert, 这属于一种pre-condition的失败, 要么是程序员粗心大意, 要么是多人合作时, 对函数语义理解有偏差, 这是危险的, 必须要加以警示.
如果要说需要额外考虑的情况, 可能在客户端程序中, 希望展现给用户的, 不是程序crash的丑态, 而是给一种友好地提示, 然后自动发送错误报告. 这种情况下, 我更倾向于用另外一个进程(或者状态隔绝的执行体)来干这件事, 侦测到某一个工作进程异常终止, 展示错误提示, 发送错误报告.</p>
<p>以上两种情况, assert不管是在debug或者release版本的代码中, 都应该保留, 而且应该通过一些手段避免被关闭.</p>
<p>除以上两种情况, 其它都不应该用assert, 比如流的输入不符合预期, malloc失败等等, 因为这些情况都不是程序员所能控制的, 是实际会发生的事实, 语义也是明确的, 应该被正确地处理. 即, <strong>外部的错误和异常, 不应该引起自身崩溃, 此时程序内部的逻辑仍然是一致的, 语义也是明确的</strong>.</p>
<hr />
<p>update(2013-09-02 21:25:00):通过搜索, 找到了几个专门处理程序在用户端crash后, 如何收集和上报出错信息的开源项目.</p>
<ol>
<li>crashrpt (https://code.google.com/p/crashrpt/)</li>
<li>google-breakpad (https://code.google.com/p/google-breakpad/)</li>
</ol>
<p>通过crashrpt提供的FAQ, 可以看出, 当程序在用户端crash后, 会自动另起一个进程来收集和发送crash的信息.</p>
  </div><!-- .content -->

</section>


    <!-- footer -->
    <footer>
      <p>
        © hhyue, license <a href=""> </a>
        unless otherwise noted.
        Generated by <a href= "http://docs.getpelican.com/">Pelican</a> with
        <a href="http://github.com/porterjamesj/crowsfoot">crowsfoot</a> theme.
      </p>
    </footer>
  </body>
</html>