<!DOCTYPE html>
<html lang="zh">

  <head>
    <title>光明顶</title>
    <link href="http://yui.yahooapis.com/3.17.2/build/cssreset/cssreset-min.css" rel="stylesheet"/>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/webfont/1.3.0/webfont.js"></script>
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>

<link href='/theme/css/prettify.css' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="http://cdn.staticfile.org/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="/theme/js/Markdown.Converter.js"></script>
<script type="text/javascript" src="/theme/js/Markdown.Extra.js"></script>
<script type="text/javascript" src="/theme/js/prettify.js"></script>
<script type="text/javascript">
        $(document).ready(function () {
            var converter = new Markdown.Converter();
            Markdown.Extra.init(converter, {
                extensions: "all",
                highlighter: "prettify"
                });
            var rawcontent = "Ketama算法是一致性Hash的一种，得益于在集群变动时命中率的优良表现，经常被用在分布式系统中进行资源定位。但在项目实践中，发现网上绝大多数ketama的实现均有些瑕疵，都无法保证在集群变动时资源的命中率达到最优。\u000A## Ketama算法的本质目标\u000A1. 资源在key\u002Dketama空间上的分布要均匀\u000A1. 节点变动前后，资源的命中失败率要最小，**且命中率损失只来自于变动的节点**。\u000A## RJ/Ketama错误实现\u000A在github上搜索Ketama，出现在第一个的是[RJ/Ketama][1]，这里提供了Ketama多种语言绑定，github上其它Ketama实现或者使用的Ketama实现大多引用于此。该实现的主要问题出现在[转到github][2]，代码摘录如下：\u000A```C\u000A    for( i \u003D 0\u003B i \u003C numservers\u003B i++ )\u000A    {\u000A        float pct \u003D (float)slist[i].memory / (float)memory\u003B\u000A        unsigned int ks \u003D floorf( pct * 40.0 * (float)numservers )\u003B\u000A#ifdef DEBUG\u000A        int hpct \u003D floorf( pct * 100.0 )\u003B\u000A\u000A        syslog( LOG_INFO, \u0022Server no. %d: %s (mem: %lu \u003D %u%% or %d of %d)\u005Cn\u0022,\u000A            i, slist[i].addr, slist[i].memory, hpct, ks, numservers * 40 )\u003B\u000A#endif\u000A\u000A        for( k \u003D 0\u003B k \u003C ks\u003B k++ )\u000A        {\u000A```\u000A上面float类型的变量```pct```是当前server的权重(这里指的memory)占所有server的权重和的比例，那么，```40 * (float)numservers```是环上点数的总和，二者相乘即为该实现求得的当前server在环上的散点数。\u000A\u000A这种做法的结果就是集群中某一个server加入或退出，其它server的散点数会发生变化，相应的，一些原本命中到无关节点的访问会被重新分配到其它节点，命中失败率会不必要地增加。且变动的server数目百分比与变动server权重和百分比相差越大时，这种放大效应会越明显。修正这种错误的方法也很简单，伪码如下：\u000A```C\u000Apoint_cnt \u003D k * weight\u000A```\u000Apoint_cnt是当前server在环上的散点数，k是放大倍数，weight是当前server的权重值(可以是按memory, cpu或者综合服务能力的一个估值)。这种方法中每个server的散点数只与自身的权重weight相关，就保证了集群有节点发生变动时，其它节点的散点不变，命中失败率就只来自变动的节点。\u000A\u000A这个问题已向作者提了issue，但现在还没有得到回应，自己就将项目中的一个[ketama实现][3]放到了github上。\u000A## 参考资料\u000A * [Wikipedia:Consistent hashing](http://en.wikipedia.org/wiki/Consistent_hashing \u0022Consistent hashing\u0022)\u000A\u000A  [1]: https://github.com/RJ/ketama\u000A  [2]: https://github.com/RJ/ketama/blob/master/libketama/ketama.c#L425\u000A  [3]: https://github.com/YueHonghui/improved_ketama \u0022ketama实现\u0022\u000A";
            var ohtml = converter.makeHtml(rawcontent);
            $('.article').append(ohtml);
            prettyPrint();
        });
</script>

    <link rel="stylesheet" type="text/css" href="./theme/css/styles.css"/>
      <meta charset="utf-8" />
  </head>

  <body id="index">
    <!-- header -->
    <header class="siteheader">
      <!-- site image -->

      <div class = "sitebanner">
        <h1><a class="sitetitle nodec" href=".">光明顶</a></h1>
        <h3 class ="sitesubtitle"></h3>
        <!-- nav -->
        <nav class="menu">
          <ul>
            <!-- menu items-->
            <!--pages-->
            <!-- services icons -->
              <li><a class="fa fa-github-alt fa-lg" href="https://github.com/YueHonghui"></a></li>
              <li><a class="fa fa-bitbucket fa-lg" href="https://bitbucket.org/YueHonghui"></a></li>
          </ul>
        </nav>
      </div> <!-- sitebanner -->
    </header>

    <!-- content -->

<section class="content">

  <h3 class="posttitle">
    <a class="nodec" href="/notes_of_ketama_algorithm_implementation.html" rel="bookmark" title="Permalink to Ketama算法实现中的细节">
      Ketama算法实现中的细节
    </a>
  </h3>

  <div class="postinfo">
    <p class="published" title="2014-04-13T15:17:00">
      2014-04-13 15:17:00
    </p>

  </div><!-- .postinfo -->

  <div class="article">
  </div><!-- .content -->
</section>


    <!-- footer -->
    <footer>
      <p>
        © hhyue, license <a href=""> </a>
        unless otherwise noted.
        Generated by <a href= "http://docs.getpelican.com/">Pelican</a> with
        <a href="http://github.com/porterjamesj/crowsfoot">crowsfoot</a> theme.
      </p>
    </footer>
  </body>
</html>