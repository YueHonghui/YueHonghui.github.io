<!DOCTYPE html>
<html lang="zh">

  <head>
    <title>光明顶</title>
    <link href="http://yui.yahooapis.com/3.17.2/build/cssreset/cssreset-min.css" rel="stylesheet"/>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/webfont/1.3.0/webfont.js"></script>
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>

<link href='/theme/css/prettify.css' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="http://cdn.staticfile.org/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="/theme/js/Markdown.Converter.js"></script>
<script type="text/javascript" src="/theme/js/Markdown.Extra.js"></script>
<script type="text/javascript" src="/theme/js/prettify.js"></script>
<script type="text/javascript">
        $(document).ready(function () {
            var converter = new Markdown.Converter();
            Markdown.Extra.init(converter, {
                extensions: "all",
                highlighter: "prettify"
                });
            var rawcontent = "## 问题描述\u000A最近，同事手里的一个C服务程序线上崩溃现象频繁，严重影响用户体验，业务数据下降明显。同事刚刚接手该服务，C语言也不是很熟悉，经过一段时间的结合日志和现象review代码，也无法根本解决该问题，于是我便与他一起排查。\u000A\u000A根据OP的报告，服务是由于占用过多内存被干死的(可能是OP或者操作系统)，最大的嫌疑便是内存泄露了。此程序由于历史久远，接手人也历经更迭，问题一直不断，估摸着内存问题不只有泄露，还可能有非法访存问题，这次也一并解决掉。\u000A\u000A## valgrind\u000A对付这种内存问题，本人一般首选valgrind，只需将程序用valgrind启动起来，然后跑一些测试用例，程序退出时输出报告，就能将绝大部分的非法访存和内存泄露暴露出来。\u000A\u000A让同事将程序迁移到测试环境，用valgrind启动，但程序在退出时，valgrind却输出了一行报警\u000A```\u000AProfiling timer expired\u000A```\u000A经过搜索，发现在stackoverflow有人碰到了相关的[问题][1]，valgrind与gprof同时使用时会有问题。查看Makefile，惊讶地发现不管是在release或者debug版本，```gcc```的```\u002Dpg```选项一直是打开的。这很不合理，在release版本中，打开gprof或多或少地会影响性能，消耗更多的资源。对于程序性能的调优，本人更倾向于perf，于是把```\u002Dpg```选项去掉了。重新编译后，在测试环境用valgrind启动程序。\u000A\u000A之后，就用已有的测试用例驱动程序，待全部跑完后，却只抓到了一个小的内存泄露点和一个非法访存的bug。经过分析，该内存泄露点的泄露量不太可能让线上服务在几天内就吃掉了8G内存，一定是我们构造的测试用例不够充分，并没有覆盖所有路径。\u000A\u000A无奈，只得在线上选取一台机器上valgrind，用线上真实数据来进行测试。\u000A\u000A## google\u002Dperftools\u000A在线上一台机器跑起valgrind后，突然想到，如果内存在进程的生命周期内没有泄露，在程序退出时有序回收了，只是内存使用的生命周期过大，在可以释放时没有释放，valgrind不就检测不出来了嘛。时间有限，为保险起见，再选一两台线上机器跑起google\u002Dperftools，每小时dump出内存的使用情况，只要在内存使用暴涨时，看看是哪个路径申请的内存占比最多，基本就能揪出原凶了。\u000A\u000A首先，需要在测试环境先行验证google\u002Dperftools的使用方法和参数，然后再发送给OP。根据安装文档提示，google\u002Dperftools在64机器上安装时，需要先安装```libunwind```，并且要特定的版本。google\u002Dperftools与jemalloc都有一个比较爽的地方，就是可以不必在编译时链接进去，只要在运行程序的时候，设置一些环境变量就行。经实验，可用参数如下：\u000A```Bash\u000A% env LD_PRELOAD\u003D\u0022/usr/lib/libtcmalloc.so\u0022 HEAPCHECK\u003Dnormal HEAPPROFILE\u003D/tmp/mybin.hprof HEAP_PROFILE_TIME_INTERVAL\u003D3600 program_to_debug\u000A```\u000A```LD_PRELOAD```指向在程序运行前加载的tcmalloc库的路径，```HEAPPROFILE```则是设置内存使用情况dump文件的保存路径。\u000A\u000A## 结果与经验\u000Agoogle\u002Dperftools的结果并没有用上，因为线上那台valgrind已经抓到了内存泄露元凶，内存泄露出在一个服务状态检索接口里。测试环境里的用例并没有覆盖该路径，这也是为什么没有在测试环境检测出来的原因。\u000A\u000A这次事件暴露了平时开发过程中质量保证没有做到位，应该在平时每次提交代码的时候就要做用例测试和内存检测，将bug消灭在萌芽状态。同时，测试环境的测试用例应该尽可能地全面，除了手动构造，还可以通过线上流量copy和日志回放来充实用例。\u000A\u000A\u000A  [1]: http://stackoverflow.com/questions/2146082/valgrind\u002Dprofiling\u002Dtimer\u002Dexpired";
            var ohtml = converter.makeHtml(rawcontent);
            $('.article').append(ohtml);
            prettyPrint();
        });
</script>

    <link rel="stylesheet" type="text/css" href="./theme/css/styles.css"/>
      <meta charset="utf-8" />
  </head>

  <body id="index">
    <!-- header -->
    <header class="siteheader">
      <!-- site image -->

      <div class = "sitebanner">
        <h1><a class="sitetitle nodec" href=".">光明顶</a></h1>
        <h3 class ="sitesubtitle"></h3>
        <!-- nav -->
        <nav class="menu">
          <ul>
            <!-- menu items-->
            <!--pages-->
            <!-- services icons -->
              <li><a class="fa fa-github-alt fa-lg" href="https://github.com/YueHonghui"></a></li>
              <li><a class="fa fa-bitbucket fa-lg" href="https://bitbucket.org/YueHonghui"></a></li>
          </ul>
        </nav>
      </div> <!-- sitebanner -->
    </header>

    <!-- content -->

<section class="content">

  <h3 class="posttitle">
    <a class="nodec" href="/experience_of_debug_memory_problem.html" rel="bookmark" title="Permalink to 内存问题处理记录">
      内存问题处理记录
    </a>
  </h3>

  <div class="postinfo">
    <p class="published" title="2014-06-28T22:08:00">
      2014-06-28 22:08:00
    </p>

  </div><!-- .postinfo -->

  <div class="article">
  </div><!-- .content -->
</section>


    <!-- footer -->
    <footer>
      <p>
        © hhyue, license <a href=""> </a>
        unless otherwise noted.
        Generated by <a href= "http://docs.getpelican.com/">Pelican</a> with
        <a href="http://github.com/porterjamesj/crowsfoot">crowsfoot</a> theme.
      </p>
    </footer>
  </body>
</html>